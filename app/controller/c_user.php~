<?php
require_once '../model/m_user.php';

	if(isset($_POST) and $_POST['submitForm'] == "SignUp" )
	{
		$document = array(
				$usr_name => $_POST['usr_name'],
				$usr_dob => $_POST['usr_dob'],
				$usr_gender => $_POST['usr_gender'],
				$usr_email => $_POST['usr_email'],
				$usr_username => $_POST['usr_username'],
				$usr_password => $_POST['usr_password'],
				$usr_cpassword => $_POST['usr_cpassword'],
				$usr_phone_no => $_POST['usr_phone_no'],
				$usr_address => array($usr_location => $_POST['usr_location'],
				      		      $usr_city => $_POST['usr_city'],
				      		      $usr_country => $_POST['usr_country']
						     );
		$error = array();

		if(count($error) == 0)
		{
			$user = new User();
			// used to access and check the particular variable i.e $usr_username 
			if($user->check_existence(array($usr_username)))
			echo array($usr_username)." already exists !";

			else {			
			  form_validation($document);
			  $user->create_user($document);
			}
		}
	}

	else if (isset($_POST) and $_POST['submitForm'] == "Login")
	{
		$document = array(
				$usr_username => $_POST['usr_username'],
				$usr_password => $_POST['usr_password'],
				);
		$error = array();

		if(count($error) == 0)
		{
			if(retrieve_user($document))
			  echo $document->$usr_username." have successfully logged in !";

			else
			  echo "This username and password do not exist !"

		}
	}

	public function form_validation()
	{
		//Validate Name
		if (empty($document->$usr_name))
			$nameError = "Name is required";
		else {
			$name = test_input($document->$usr_name);
			if (!preg_match("/^[a-zA-Z ]*$/",$name))
				$nameError = "Only letters and white space allowed";
		     }

		//Validate Gender
		if (empty($document->$usr_gender))
			$genderError = "Gender is required";
		else
			$gender = test_input($document->$usr_gender);

		//Validate Email-Id
		if (empty($document->$usr_email))
			$emailError = "Email is required";
		else {
			$email = test_input($document->$usr_email);
			// check if e-mail address syntax is valid or not
			if (!preg_match("/([\w\-]+\@[\w\-]+\.[\w\-]+)/",$email))
				$emailError = "Invalid email format";
		     }

		//Validate Username
		if (empty($document->$usr_username))
			$usernameError = "Name is required";
		else {
			$username = test_input($document->$usr_username);
			// check name only contains letters and whitespace
			if (!preg_match("/^[a-zA-Z ]*$/",$username))
				$usernameError = "Only letters and white space allowed";
		     }

		
		//Validate Password and Confirm Password
		if (!empty($document->$usr_password) && ($document->$usr_password == $document->$usr_cpassword)) {
        		$password = test_input($document->$usr_password);
        		$cpassword = test_input($document->$usr_cpassword);
        		if (strlen($document->$usr_password) <= '8')
            			$passwordErr = "Your Password Must Contain At Least 8 Characters!";
        		elseif(!preg_match("#[0-9]+#",$password))
            			$passwordErr = "Your Password Must Contain At Least 1 Number!";
        		elseif(!preg_match("#[A-Z]+#",$password))
            			$passwordErr = "Your Password Must Contain At Least 1 Capital Letter!";
        		elseif(!preg_match("#[a-z]+#",$password))	
            			$passwordErr = "Your Password Must Contain At Least 1 Lowercase Letter!";
			else	
            			$cpasswordErr = "Please Check You've Entered Or Confirmed Your Password!";
        	}
		else
			$passwordErr = "Password is required";

		//Validate Phone Number
		if (empty($document->$usr_phone_no))
			$phnoError = "Phone number is required";
		else {
			$phno = test_input($document->$usr_phone_no);
			if (!preg_match("/[^0-9]/",$phno) && strlen($phno) == 10)
				$phnoError = "Invalid Phone Number";
		     }

		//Validate Address
		if (empty($document->$usr_address))
			$addressError = "Address is required";
		else {
			$address = test_input($document->$usr_address);
			$regex1 = '/^[a-zA-Z\- ]+[ \t]*\d[0-9a-z]*$/';
			$regex2 = '/^[a-zA-Z ]*$/';
			$regex3 = '/^[a-zA-Z ]*$/';
			if (!preg_match($regex1,$document->$usr_address->$usr_location) or !preg_match($regex2,$document->$usr_address->$usr_city) 					or !preg_match($regex3,$document->$usr_address->$usr_country))
			  $addressError = "Invalid Address";
		     }
		
	}

	public function retrieve_user($document)
	{
		$user = new User();
		
		return $user->retrieve_user($document);
	}

	public function update_user($document)
	{
		form_validation($document);
		$user = new User();
		$user->update_user($document);
	}

	public function test_input($data) {
		$data = trim($data);
		$data = stripslashes($data);
		//$data = htmlspecialchars($data);
		return $data;
	}
?>
